# KzVisaBot

Telegram-бот для мониторинга доступных слотов собеседования (US Visa, Казахстан) на сайте https://ais.usvisa-info.com/ru-kz/niv и отправки уведомлений.

Проект делаем поэтапно (см. `Technical_Specification.md`). На ближайшем этапе фокус: **парсер + уведомления в Telegram**. Автоматическая запись на слоты будет добавляться сильно позже.

## Цели проекта (MVP)

- 24/7 (с заданным интервалом) проверять доступные даты.
- Хранить найденные даты/слоты в БД (**PostgreSQL**).
- При появлении новых слотов — отправлять уведомления в Telegram.
- Архитектурно быть готовым к замене движка парсинга (**Selenium** или **Playwright**) без переписывания бизнес-логики.

## Архитектура (черновик, будем придерживаться)

Основная идея — **слабая связность**: бизнес-логика не знает, чем именно парсим сайт и как именно ходим в БД.

### Слои и контракты

- **Domain (ядро)**
  - типы и модели: «Аккаунт/кабинет», «Заявитель», «Слот/дата», «Диапазон желаемых дат», правила выбора.
  - сценарии (use cases):
    - `FetchAvailableSlots` — получить доступные слоты из внешнего источника;
    - `StoreSlots` — сохранить слоты в БД;
    - `NotifyOnNewSlots` — сравнить с предыдущим состоянием и отправить уведомления.

- **Adapters / Infrastructure (края системы)**
  - **Парсер (Web)**: реализация интерфейса `SlotsProvider`.
    - Вариант A: Selenium
    - Вариант B: Playwright
    - Доменные сценарии работают с интерфейсом, а не с конкретной библиотекой.
  - **Хранилище (Postgres)**: реализация репозиториев.
    - `slots_repository` — читать/писать слоты (и дельты).
    - позже: `accounts_repository`, `subscriptions_repository`.
  - **Telegram**: отправка сообщений + (позже) команды для настройки.

- **App / Entrypoints**
  - CLI/скрипт/воркер, который:
    - по расписанию запускает обновление слотов;
    - вызывает доменные use cases;
    - логирует и обрабатывает ошибки.

### Почему так

- Можно переключить Selenium → Playwright, не трогая use cases.
- Можно заменить Postgres → другое хранилище, не меняя логику.
- Проще тестировать (моки вместо реального браузера/БД).

## Хранение данных (план)

База: **PostgreSQL**.

Минимально на раннем этапе:

- таблица/сущность слотов (`slots`): дата/время, локация, тип, признак доступности, время обнаружения.
- таблица состояния последней проверки (можно начать с отдельной таблицы или хранить «последний снимок»).
- позже: пользователи/подписки/кабинеты.

## Конфигурация

Настройки лежат в `.env` (для отладки уже подготовлен).

Смотри также `.env.example`.

Ожидаемые группы переменных (названия могут уточняться по мере реализации):

- Telegram: токен бота.
- Postgres: `host/port/db/user/password`.
- Web-парсер: логин/пароль кабинета, параметры антибот-защиты (если понадобится), прокси.
- Scheduler: интервал проверки.

## Как будем развивать (пайплайн работ)

1) **Парсер слотов** (Selenium/Playwright) → возвращает нормализованные слоты.
2) **Persist + diff**: сохраняем в Postgres и определяем «новые слоты».
3) **Уведомления в Telegram**: отправляем при появлении новых слотов.
4) Команды Telegram для настройки подписок/кабинетов.
5) (Позже) Автоматическая запись на слоты.

## Примечания и риски

- Сайт использует антибот-защиту (Cloudflare/reCAPTCHA). Возможно понадобятся headless-браузер, прокси и внешние сервисы решения капч. Это ломкое место.
- Форматы дат/слотов должны быть **нормализованы** (в доменном слое) — не сравниваем строки «как есть».

## Референс

В папке `other-visa-checker/` лежит пример похожего проекта и его описание архитектуры. Он полезен как прототип, но в нашем проекте целимся в более модульную структуру и Postgres.

